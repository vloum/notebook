# ============================================================
# NoteBrain PostgreSQL Configuration (Production)
# Tuned for: 4 CPU / 8GB RAM server
# Adjust values if your server specs differ
# ============================================================

# --- Connection ---
listen_addresses = '*'
max_connections = 100
superuser_reserved_connections = 3

# --- Memory ---
# shared_buffers: ~25% of total RAM
shared_buffers = 2GB
# effective_cache_size: ~75% of total RAM (tells planner about OS cache)
effective_cache_size = 6GB
# work_mem: per-operation sort/hash memory
work_mem = 32MB
# maintenance_work_mem: VACUUM, CREATE INDEX, etc.
# Set high for pgvector HNSW index creation
maintenance_work_mem = 512MB

# --- WAL (Write-Ahead Logging) ---
wal_level = replica
max_wal_senders = 3
wal_buffers = 64MB
min_wal_size = 1GB
max_wal_size = 4GB
checkpoint_completion_target = 0.9

# --- WAL Archiving (for PITR backup) ---
archive_mode = on
archive_command = 'test ! -f /backups/wal/%f && cp %p /backups/wal/%f'
archive_timeout = 300

# --- Data Integrity ---
fsync = on
synchronous_commit = on
full_page_writes = on

# --- Query Planner ---
# SSD optimized
random_page_cost = 1.1
effective_io_concurrency = 200

# --- Parallel Query ---
max_worker_processes = 4
max_parallel_workers_per_gather = 2
max_parallel_workers = 4
max_parallel_maintenance_workers = 2

# --- Autovacuum ---
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 60
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_scale_factor = 0.05

# --- Logging ---
log_destination = 'stderr'
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_duration_statement = 1000
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 0
log_timezone = 'Asia/Shanghai'

# --- Locale ---
timezone = 'Asia/Shanghai'
lc_messages = 'en_US.utf8'

# --- pgvector specific ---
# HNSW index build parallelism (0 = use max_parallel_maintenance_workers)
# Increase maintenance_work_mem before building large HNSW indexes
